{% import "ui.html" as ui %} {% extends "layout.html" %} {% block title %}{{
data.piece.metaTitle }}{% endblock %} {% block extraHead %}{{ super() }}
<meta name="description" content="{{ data.piece.metaDescription }}" />
<link rel="canonical" href="{{data.url}}" />
{% endblock %} {% block main %}
<section
  class="blogSection lg:mx-16 mb-0 flex flex-col lg:flex-row justify-between gap-6 lg:gap-8"
  id="blog-main-content"
>
  <div class="lg:w-3/4">
    <nav
      aria-label="breadcrumb"
      class="breadcrumbNav max-[1024px]:px-8 my-2 text-sm lg:text-base w-full overflow-hidden"
    >
      <ol class="flex space-x-2 text-[#020407] capitalize items-center">
        {% if data.page._ancestors and data.page._ancestors | length > 0 %} {%
        set lastAncestor = data.page._ancestors | last %}
        <li class="flex items-center ml-2 p-1">
          <a href="{{ lastAncestor._url }}" class="text-[#020407]"
            >{{ lastAncestor.title }}</a
          >
          <span class="mx-1">></span>
        </li>
        {% endif %}
        <li class="capitalize flex items-center p-1">
          <a href="{{ data.page._url }}" class="text-[#020407]"
            >{{ data.page.title }}</a
          >
        </li>
        <span class="mx-1">></span>
        <li
          class="flex items-center p-1 text-[#020407] font-bold capitalize truncate"
        >
          <a
            href="{{ data.piece._url }}"
            class="text-[#020407] breadcrumbWrapper truncate"
            >{{ data.piece.title }}</a
          >
        </li>
      </ol>
    </nav>
    <div class="BlogDetails">
      <div
        class="relative rounded-3xl md:flex items-baseline overflow-hidden max-[1024px]:mx-8"
      >
        <div class="w-full relative">
          <div class="BannerImage">
            {% set image = apos.image.first(data.piece.bannerImage) %}
            {% if image %}
              <img 
                src="{{ apos.attachment.url(image, { size: 'full' }) }}" 
                alt="{{ image._alt or '' }}" 
                width="{{ image.width or '' }}" 
                height="{{ image.height or '' }}"
                class="img-fluid"
              >
            {% endif %}
          </div>
          <div
            class="absolute inset-0 bg-gradient-to-b rounded-b-3xl from-transparent to-black"
          ></div>
          <div
            class="absolute bottom-4 w-full px-5 lg:px-10 bg-transparent bg-opacity-60 text-white p-3 md:p-4"
          >
            <div class="flex flex-wrap gap-2 mb-3 font-medium">
              {% if data.piece.blog_type %}
              <span
                class="inline-flex items-center px-3 py-1 gap-2 rounded-full text-base font-medium"
                style="background-color: #d1f7d1; color: #1c1e21"
              >
                {% if data.piece.blog_type == 'podcast' %}
                <svg
                  width="14"
                  height="14"
                  viewBox="0 0 14 14"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M6 13.0002V8.15016C5.8 8.02794 5.63889 7.86961 5.51667 7.67516C5.39444 7.48072 5.33333 7.25572 5.33333 7.00016C5.33333 6.6335 5.46389 6.31961 5.725 6.0585C5.98611 5.79738 6.3 5.66683 6.66667 5.66683C7.03333 5.66683 7.34722 5.79738 7.60833 6.0585C7.86944 6.31961 8 6.6335 8 7.00016C8 7.25572 7.93889 7.4835 7.81667 7.6835C7.69444 7.8835 7.53333 8.03905 7.33333 8.15016V13.0002C7.33333 13.1891 7.26944 13.3474 7.14167 13.4752C7.01389 13.6029 6.85556 13.6668 6.66667 13.6668C6.47778 13.6668 6.31944 13.6029 6.19167 13.4752C6.06389 13.3474 6 13.1891 6 13.0002ZM2.55 11.3502C2.41667 11.4835 2.25556 11.5502 2.06667 11.5502C1.87778 11.5502 1.72222 11.4779 1.6 11.3335C1.1 10.7446 0.708333 10.0835 0.425 9.35016C0.141667 8.61683 0 7.8335 0 7.00016C0 6.07794 0.175 5.21127 0.525 4.40016C0.875 3.58905 1.35 2.8835 1.95 2.2835C2.55 1.6835 3.25556 1.2085 4.06667 0.858496C4.87778 0.508496 5.74444 0.333496 6.66667 0.333496C7.58889 0.333496 8.45555 0.508496 9.26667 0.858496C10.0778 1.2085 10.7833 1.6835 11.3833 2.2835C11.9833 2.8835 12.4583 3.58905 12.8083 4.40016C13.1583 5.21127 13.3333 6.07794 13.3333 7.00016C13.3333 7.8335 13.1917 8.61683 12.9083 9.35016C12.625 10.0835 12.2333 10.7446 11.7333 11.3335C11.6111 11.4779 11.4583 11.5529 11.275 11.5585C11.0917 11.5641 10.9333 11.5002 10.8 11.3668C10.6778 11.2446 10.6167 11.0891 10.6167 10.9002C10.6167 10.7113 10.6778 10.5446 10.8 10.4002C11.1778 9.9335 11.4722 9.41127 11.6833 8.8335C11.8944 8.25572 12 7.64461 12 7.00016C12 5.51127 11.4833 4.25016 10.45 3.21683C9.41667 2.1835 8.15555 1.66683 6.66667 1.66683C5.17778 1.66683 3.91667 2.1835 2.88333 3.21683C1.85 4.25016 1.33333 5.51127 1.33333 7.00016C1.33333 7.64461 1.43889 8.25294 1.65 8.82516C1.86111 9.39738 2.16111 9.91683 2.55 10.3835C2.67222 10.5279 2.73611 10.6918 2.74167 10.8752C2.74722 11.0585 2.68333 11.2168 2.55 11.3502ZM4.43333 9.46683C4.3 9.60016 4.13889 9.66961 3.95 9.67516C3.76111 9.68072 3.61111 9.60572 3.5 9.45016C3.24444 9.10572 3.04167 8.72794 2.89167 8.31683C2.74167 7.90572 2.66667 7.46683 2.66667 7.00016C2.66667 5.88905 3.05556 4.94461 3.83333 4.16683C4.61111 3.38905 5.55556 3.00016 6.66667 3.00016C7.77778 3.00016 8.72222 3.38905 9.5 4.16683C10.2778 4.94461 10.6667 5.88905 10.6667 7.00016C10.6667 7.46683 10.5917 7.9085 10.4417 8.32516C10.2917 8.74183 10.0889 9.11683 9.83333 9.45016C9.72222 9.59461 9.57222 9.66961 9.38333 9.67516C9.19444 9.68072 9.03333 9.61683 8.9 9.4835C8.77778 9.36127 8.71389 9.20572 8.70833 9.01683C8.70278 8.82794 8.75556 8.65572 8.86667 8.50016C9.01111 8.27794 9.125 8.04183 9.20833 7.79183C9.29167 7.54183 9.33333 7.27794 9.33333 7.00016C9.33333 6.26683 9.07222 5.63905 8.55 5.11683C8.02778 4.59461 7.4 4.3335 6.66667 4.3335C5.93333 4.3335 5.30556 4.59461 4.78333 5.11683C4.26111 5.63905 4 6.26683 4 7.00016C4 7.28905 4.04167 7.55572 4.125 7.80016C4.20833 8.04461 4.32222 8.27794 4.46667 8.50016C4.57778 8.65572 4.63056 8.82516 4.625 9.0085C4.61944 9.19183 4.55556 9.34461 4.43333 9.46683Z"
                    fill="black"
                  />
                </svg>
                {% elif data.piece.blog_type == 'article' %}
                <svg
                  width="14"
                  height="14"
                  viewBox="0 0 12 12"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M1.72222 11.5C1.38611 11.5 1.09838 11.3803 0.859028 11.141C0.619676 10.9016 0.5 10.6139 0.5 10.2778V1.72222C0.5 1.38611 0.619676 1.09838 0.859028 0.859028C1.09838 0.619676 1.38611 0.5 1.72222 0.5H10.2778C10.6139 0.5 10.9016 0.619676 11.141 0.859028C11.3803 1.09838 11.5 1.38611 11.5 1.72222V10.2778C11.5 10.6139 11.3803 10.9016 11.141 11.141C10.9016 11.3803 10.6139 11.5 10.2778 11.5H1.72222ZM3.55556 9.05556H6.61111C6.78426 9.05556 6.9294 8.99699 7.04653 8.87986C7.16366 8.76273 7.22222 8.61759 7.22222 8.44444C7.22222 8.2713 7.16366 8.12616 7.04653 8.00903C6.9294 7.8919 6.78426 7.83333 6.61111 7.83333H3.55556C3.38241 7.83333 3.23727 7.8919 3.12014 8.00903C3.00301 8.12616 2.94444 8.2713 2.94444 8.44444C2.94444 8.61759 3.00301 8.76273 3.12014 8.87986C3.23727 8.99699 3.38241 9.05556 3.55556 9.05556ZM3.55556 6.61111H8.44444C8.61759 6.61111 8.76273 6.55255 8.87986 6.43542C8.99699 6.31829 9.05556 6.17315 9.05556 6C9.05556 5.82685 8.99699 5.68171 8.87986 5.56458C8.76273 5.44745 8.61759 5.38889 8.44444 5.38889H3.55556C3.38241 5.38889 3.23727 5.44745 3.12014 5.56458C3.00301 5.68171 2.94444 5.82685 2.94444 6C2.94444 6.17315 3.00301 6.31829 3.12014 6.43542C3.23727 6.55255 3.38241 6.61111 3.55556 6.61111ZM3.55556 4.16667H8.44444C8.61759 4.16667 8.76273 4.1081 8.87986 3.99097C8.99699 3.87384 9.05556 3.7287 9.05556 3.55556C9.05556 3.38241 8.99699 3.23727 8.87986 3.12014C8.76273 3.00301 8.61759 2.94444 8.44444 2.94444H3.55556C3.38241 2.94444 3.23727 3.00301 3.12014 3.12014C3.00301 3.23727 2.94444 3.38241 2.94444 3.55556C2.94444 3.7287 3.00301 3.87384 3.12014 3.99097C3.23727 4.1081 3.38241 4.16667 3.55556 4.16667Z"
                    fill="#1C1E21"
                  />
                </svg>
                {% endif %}
                <span class="text-sm"
                  >{{ data.piece.blog_type | capitalize }}</span
                >
              </span>
              {% endif %} {% if data.piece.category %}
              <span
                class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium capitalize"
                style="background-color: #ffffcc; color: #1c1e21"
              >
                {{ data.piece.category }}
              </span>
              {% endif %}
            </div>
            <h1 class="text-2xl lg:text-3xl font-bold lg:w-9/12 mt-2.5">
              {{ data.piece.title }}
            </h1>
            <div class="flex flex-wrap justify-between w-full lg:gap-4">
              {% if (data.piece.authorPhoto and data.piece.authorPhoto.items |
              length > 0) or data.piece.authorName or data.piece.publishedDate
              or data.piece.readingTime or (data.piece.socialLinks and
              data.piece.socialLinks | length > 0) %}

              <div
                class="flex gap-4 items-center mt-6 lg:mt-[38px] max-sm:order-2"
              >
                {% if (data.piece.authorPhoto and data.piece.authorPhoto.items |
                length > 0) %}
                <div class="blog-author-photo w-10 h-10 object-cover">
                  {% area data.piece, 'authorPhoto' %}
                </div>
                {% endif %}
                <div class="flex flex-col leading-5">
                  <div class="text-base font-bold">
                    {{ data.piece.authorName }}
                  </div>
                  <div class="flex gap-2 text-sm">
                    <div>
                      {% if data.piece.publishedDate %} Published on {{
                      data.piece.publishedDate | date('DD MMM, YYYY') }} {%
                      endif %}
                    </div>
                    <div>
                      {% if data.piece.readingTime %}{{
                      data.piece.readingTime}}min read{% endif %}
                    </div>
                  </div>
                </div>
              </div>
              {% endif %}
              <div class="flex gap-3 items-center mt-4 lg:mt-10">
                <a
                  href="https://www.linkedin.com/shareArticle?mini=true&url={{ data.piece._url }}&title={{ data.piece.title }}"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="max-sm:bg-[#FFFFFF29] max-sm:p-2 max-sm:rounded-full max-sm:w-10 max-sm:h-10 max-sm:flex max-sm:items-center max-sm:justify-center"
                >
                  <img
                    src="/images/social-icons/linkedin.svg"
                    alt="Share on LinkedIn"
                    class="w-5 h-4 object-contain"
                    width="18"
                    height="18"
                    style="width: auto; height: auto"
                  />
                </a>
                <a
                  href="https://www.facebook.com/sharer/sharer.php?u={{ data.piece._url }}"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="max-sm:bg-[#FFFFFF29] max-sm:p-2 max-sm:rounded-full max-sm:w-10 max-sm:h-10 max-sm:flex max-sm:items-center max-sm:justify-center"
                >
                  <img
                    src="/images/social-icons/facebook.svg"
                    alt="Share on Facebook"
                    class="w-5 h-4 object-contain"
                    width="8"
                    height="18"
                    style="width: auto; height: auto"
                  />
                </a>
                <a
                  href="https://twitter.com/intent/tweet?url={{ data.piece._url }}&text={{ data.piece.title }}"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="max-sm:bg-[#FFFFFF29] max-sm:p-2 max-sm:rounded-full max-sm:w-10 max-sm:h-10 max-sm:flex max-sm:items-center max-sm:justify-center"
                >
                  <img
                    src="/images/social-icons/twitter.svg"
                    alt="Share on X"
                    class="w-5 h-4 object-contain"
                    width="24"
                    height="24"
                    style="width: auto; height: auto"
                  />
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div
        class="block lg:hidden mt-4 p-6 bg-black rounded-3xl font-bold max-[1024px]:mx-8"
      >
        <p class="text-xl text-white">
          Get a <span class="text-yellow">free accessibility report</span> on
          your website now!
        </p>
        <a
          href="#home_audit"
          class="mt-3 text-base bg-yellow py-3 px-5 rounded-full"
          aria-label="CLick here to get free report"
          id="scrollToForm_mobile"
        >
          Get Free Report
        </a>
      </div>
      {% if data.piece.podcastEmbed.code %}
      <div class="flex lg:hidden fading-border mt-4 max-[1024px]:mx-8 !w-auto">
        <div class="fading-border-inner p-3">
          {{ data.piece.podcastEmbed.code | safe }}
        </div>
      </div>
      {% endif %}
      <div
        class="block lg:hidden mt-4 sticky top-[60px] md:top-[82px] bg-white"
      >
        <button
          id="toggleToc"
          class="w-full flex justify-between items-center p-3 border border-black transition-colors"
        >
          <span id="selectedTopic" class="text-left">Introduction</span>
          <svg
            id="arrowIcon"
            width="18"
            height="10"
            viewBox="0 0 18 10"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              id="arrowPath"
              d="M9.00392 10C9.20693 10 9.39591 9.96803 9.57085 9.90409C9.74578 9.84015 9.91216 9.73054 10.07 9.57525L17.6418 2.11127C17.8749 1.88126 17.9942 1.59214 17.9998 1.24393C18.0052 0.895994 17.8858 0.601619 17.6418 0.360806C17.3975 0.120269 17.1016 0 16.7539 0C16.4063 0 16.1103 0.120269 15.866 0.360806L9.00392 7.1256L2.14179 0.360806C1.90844 0.131064 1.61515 0.0134248 1.26191 0.00788883C0.908943 0.00262968 0.610313 0.120269 0.36602 0.360806C0.122007 0.601619 0 0.893365 0 1.23604C0 1.57871 0.122007 1.87046 0.36602 2.11127L7.93787 9.57525C8.09568 9.73054 8.26205 9.84015 8.43699 9.90409C8.61192 9.96803 8.8009 10 9.00392 10Z"
              fill="black"
            />
          </svg>
        </button>
        <div
          id="tocContainer"
          class="hidden lg:w-full bg-white rounded-lg mt-4 max-[1024px]:mx-8"
        >
          <div class="p-3 sm:p-4 md:p-6">
            <div class="text-lg font-semibold text-[#434141] mb-4">
              Table of Content
            </div>
            <div id="sidebarDropdown"></div>
          </div>
        </div>
      </div>
      <a
        href="#tableContent"
        class="skip-table my-3 rounded-full max-[1023px]:hidden"
      >
        Skip to Table of Content</a
      >

      <h2 class="sr-only">Learn more about {{ data.piece.title }}</h2>
      <div
        class="BlogContentSection w-full mt-4 lg:mt-6 max-[1024px]:px-8"
        id="content"
      >
        {% area data.piece, 'content' %}
      </div>
    </div>
  </div>
  <div class="lg:w-1/4 lg:flex flex-col gap-4 lg:mt-12">
    <div
      class="p-6 bg-black rounded-3xl font-bold accessibilityReportSection hidden lg:block"
    >
      <p class="text-xl text-white">
        Get a <span class="text-yellow">free accessibility report</span> on your
        website now!
      </p>
      <a
        href="#home_audit"
        class="mt-3 text-base bg-yellow py-3 px-5 rounded-full"
        aria-label="CLick here to get free report"
        id="scrollToForm"
      >
        Get Free Report
      </a>
    </div>
    {% if data.piece.podcastEmbed.code %}
    <div class="fading-border hidden lg:block" id="podcast">
      <div class="fading-border-inner p-3">
        {{ data.piece.podcastEmbed.code | safe }}
      </div>
    </div>
    {% endif %}
    <div class="sticky top-[90px]">
      <div class="toc-wrapper relative" id="tableContent">
        <div class="tocDiv fading-border hidden lg:block h-fit">
          <div class="fading-border-inner p-4">
            <div class="text-base font-semibold text-[#434141] mb-4">
              Table Of Content
            </div>
            <div
              id="sidebar"
              class="overflow-x-hidden overflow-y-auto"
              style="max-height: calc(100vh - 160px)"
            ></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<section
  class="lg:mx-16 mx-8 widget-columns widget-columns--single widget-my-spacing pt-4 pb-6 lg:pt-12 lg:pb-12 rounded-3xl bg-white"
  id="home_audit"
>
  <div style="background-color: #000000ff" class="rounded-3xl">
    <div class="widget-columns__column column-item__first !w-full">
      <div class="apos-area">
        <section
          class="is-fluid side-by-side justify-between widget-my-spacing md:!gap-0 !flex-col lg:!flex-row auditWebsite flex flex-col md:flex-row"
        >
          <div class="side-by-side__column-item column-item__first w-[70%]">
            <div class="apos-area">
              <section
                class="mx-8 lg:mx-16 widget-columns widget-columns--single widget-my-spacing home-page-report-form-container accessible_website py-5 lg:py-16"
              >
                <div class="widget-columns__column column-item__first">
                  <div class="apos-area">
                    <section class="widget-my-spacing">
                      <div class="apos-area">
                        <div data-rich-text="">
                          <p class="h2 text-3xl lg:text-5xl">
                            <span class="highlight-secondary"
                              ><strong
                                ><span
                                  >Not sure if you're accessible? Audit your
                                  website for free</span
                                ></strong
                              ></span
                            >
                          </p>
                        </div>
                      </div>
                    </section>
                    <section
                      class="widget-my-spacing pt-3 md:pt-6"
                      id="color-darkgrey"
                    >
                      <div class="apos-area">
                        <div data-rich-text="">
                          <p class="p">
                            <span class="highlight-secondary"
                              ><span
                                >Get actionable insights instantly and ensure
                                your website is fully accessible to all
                                users.</span
                              ></span
                            >
                          </p>
                        </div>
                      </div>
                    </section>
                    <section
                      id="BlogwebsiteForm"
                      class="custom-form widget-py-spacing websiteFreeForm report-form audit_free pt-4 md:pt-8 form-widget-container roundedRadius md:flex md:justify-start pt-6 formWidth pb-4"
                    >
                      {% area data.global, 'form' %}
                    </section>
                  </div>
                </div>
              </section>
            </div>
          </div>
          <div class="side-by-side__column-item column-item__second w-[30%]">
            <div class="apos-area">
              <section
                class="is-fluid widget-columns widget-columns--single widget-my-spacing shapeImg"
              >
                <div class="widget-columns__column column-item__first">
                  <div class="apos-area">
                    <section class="widget-my-spacing image-widget shapeImg">
                      <img
                        class="img-fluid"
                        srcset="
                          https://apostrophe-wallyax.s3.amazonaws.com/attachments/cm5l25yvl3eqycgpgaggj4n7k-wally-3-0-mask-group.max.png       411w,
                          https://apostrophe-wallyax.s3.amazonaws.com/attachments/cm5l25yvl3eqycgpgaggj4n7k-wally-3-0-mask-group.one-third.png 380w,
                          https://apostrophe-wallyax.s3.amazonaws.com/attachments/cm5l25yvl3eqycgpgaggj4n7k-wally-3-0-mask-group.one-sixth.png 190w
                        "
                        src="https://apostrophe-wallyax.s3.amazonaws.com/attachments/cm5l25yvl3eqycgpgaggj4n7k-wally-3-0-mask-group.full.png"
                        alt="Decorative image"
                        aria-hidden="true"
                        width="411"
                        height="498"
                      />
                    </section>
                  </div>
                </div>
              </section>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>
</section>
<button
  id="scrollToTop"
  class="scroll-to-top bg-yellow"
  aria-label="Scroll to Top"
>
  <img
    src="/images/vector.svg"
    alt="Scroll to top"
    width="22"
    height="12"
    style="width: auto; height: auto"
  />
</button>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const mobileSidebar = document.getElementById("sidebarDropdown");
    const desktopSidebar = document.getElementById("sidebar");
    const headings = document.querySelectorAll(
      "#content h1, #content h2, #content h3, #content h4, #content h5, #content h6, #content .blogheading"
    );
    const selectedTopic = document.getElementById("selectedTopic");
    const toggleTocButton = document.getElementById("toggleToc");
    const tocContainer = document.getElementById("tocContainer");
    const arrowIcon = document.getElementById("arrowIcon");

    const mobileOffset = 120;
    const desktopOffset = 80;
    let firstHeadingId = null;

    function createTocEntries(sidebar, isMobile = false) {
      sidebar.innerHTML = "";
      let firstHeadingText = null;

      headings.forEach((heading, index) => {
        const id = `heading-${index}`;
        heading.id = id;

        const link = document.createElement("a");
        link.href = `#${id}`;
        link.className =
          "flex items-center text-base p-4 bg-[#F7F5F5] text-black m-2 rounded-lg transition-colors";
        link.innerHTML = `<p class="text-base">${heading.textContent}</p>`;

        link.addEventListener("click", (e) => {
          e.preventDefault();

          if (isMobile) {
            tocContainer.classList.add("hidden");
            arrowIcon.style.transform = "rotate(0deg)";
            selectedTopic.textContent = heading.textContent;
          }

          setTimeout(() => {
            const targetElement = document.getElementById(id);
            
            // Use requestAnimationFrame to avoid forced reflow
            requestAnimationFrame(() => {
              const elementPosition =
                targetElement.getBoundingClientRect().top + window.scrollY;
              
              requestAnimationFrame(() => {
                window.scrollTo({
                  top:
                    elementPosition - (isMobile ? mobileOffset : desktopOffset),
                  behavior: "smooth",
                });
              });
            });
          }, 50);
        });

        sidebar.appendChild(link);

        if (index === 0) {
          firstHeadingText = heading.textContent;
          firstHeadingId = id;
        }
      });

      if (isMobile && firstHeadingText) {
        selectedTopic.textContent = firstHeadingText;
      }
    }

    createTocEntries(mobileSidebar, true);
    createTocEntries(desktopSidebar, false);

    const observerOptions = {
      root: null,
      rootMargin: `-${mobileOffset}px 0px -80% 0px`,
      threshold: 0,
    };

    let activeId = null;

    const observer = new IntersectionObserver((entries) => {
      let visibleHeadings = entries
        .filter((entry) => entry.isIntersecting)
        .map((entry) => entry.target);

      if (visibleHeadings.length > 0) {
        // Batch all getBoundingClientRect calls to avoid forced reflow
        const headingPositions = visibleHeadings.map(heading => ({
          heading,
          top: heading.getBoundingClientRect().top
        }));
        
        let closestHeading = headingPositions[0].heading;
        let closestTop = headingPositions[0].top;

        for (let i = 1; i < headingPositions.length; i++) {
          if (headingPositions[i].top < closestTop) {
            closestHeading = headingPositions[i].heading;
            closestTop = headingPositions[i].top;
          }
        }

        const id = closestHeading.id;
        if (activeId !== id) {
          activeId = id;

          document
            .querySelectorAll("#sidebarDropdown a, #sidebar a")
            .forEach((el) => {
              el.classList.remove("bg-[#FFD60280]", "font-bold");
            });
          const activeMobileLink = document.querySelector(
            `#sidebarDropdown a[href="#${id}"]`
          );
          if (activeMobileLink) {
            activeMobileLink.classList.add("bg-[#FFD60280]", "font-bold");
            selectedTopic.textContent = activeMobileLink.textContent.trim();
            scrollToActiveToC(activeMobileLink, mobileSidebar);
          }

          const activeDesktopLink = document.querySelector(
            `#sidebar a[href="#${id}"]`
          );
          if (activeDesktopLink) {
            activeDesktopLink.classList.add("bg-[#FFD60280]", "font-bold");
            scrollToActiveToC(activeDesktopLink, desktopSidebar);
          }
        }
      }
    }, observerOptions);

    headings.forEach((heading) => observer.observe(heading));

    toggleTocButton.addEventListener("click", () => {
      const isHidden = tocContainer.classList.toggle("hidden");
      arrowIcon.style.transform = isHidden ? "rotate(0deg)" : "rotate(180deg)";
    });

    if (firstHeadingId) {
      setTimeout(() => {
        const firstMobileLink = document.querySelector(
          `#sidebarDropdown a[href="#${firstHeadingId}"]`
        );
        if (firstMobileLink) {
          firstMobileLink.classList.add("bg-[#FFD60280]", "font-bold");
          scrollToActiveToC(firstMobileLink, mobileSidebar);
        }

        const firstDesktopLink = document.querySelector(
          `#sidebar a[href="#${firstHeadingId}"]`
        );
        if (firstDesktopLink) {
          firstDesktopLink.classList.add("bg-[#FFD60280]", "font-bold");
          scrollToActiveToC(firstDesktopLink, desktopSidebar);
        }
      }, 100);
    }

    function scrollToActiveToC(activeLink, tocContainer) {
      if (!tocContainer) return;
      // Use requestAnimationFrame to batch DOM reads and avoid forced reflow
      requestAnimationFrame(() => {
        const linkRect = activeLink.getBoundingClientRect();
        const containerRect = tocContainer.getBoundingClientRect();

        if (
          linkRect.top < containerRect.top ||
          linkRect.bottom > containerRect.bottom
        ) {
          requestAnimationFrame(() => {
            tocContainer.scrollTo({
              top: activeLink.offsetTop - tocContainer.offsetHeight / 2,
              behavior: "smooth",
            });
          });
        }
      });
    }
  });
</script>

{% endblock %}
