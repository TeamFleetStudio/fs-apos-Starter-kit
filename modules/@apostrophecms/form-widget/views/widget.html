{% set widget = data.widget %}
{% set form = data.widget._form[0] %}
{% set classPrefix = data.widget.classPrefix %}
{% set prependIfPrefix = apos.modules['@apostrophecms/form'].prependIfPrefix %}
{% set captchaSite = apos.modules['@apostrophecms/form'].options.recaptchaSite or (data.global.useRecaptcha and data.global.recaptchaSite) %}
{% set enableRecaptcha = form.enableRecaptcha and captchaSite %}

{% if enableRecaptcha %}
<script src="https://www.google.com/recaptcha/api.js?render={{ captchaSite }}"></script>
<script>
  (function() {
    const formId = "{{ form._id }}";
    const siteKey = "{{ captchaSite }}";
    
    window.addEventListener("load", function () {
      if (typeof grecaptcha === 'undefined') {
        return;
      }
      grecaptcha.ready(function () {
        grecaptcha.execute(siteKey, { action: "submit" })
          .then(function (token) {
            const tokenInput = document.getElementById("recaptchaToken-" + formId);
            if (tokenInput) {
              tokenInput.value = token;
            }
          })
          .catch(function (error) {
            // Silent error handling
          });
      });
    });
    
    // Handle form submission to regenerate token if needed
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.querySelector('[data-apos-form-form="' + formId + '"]');
      if (!form) return;
      
      form.addEventListener('submit', async function(e) {
        const tokenInput = form.querySelector('input[name="recaptchaToken"]');
        const recaptchaError = form.closest('[data-apos-form-wrapper]')?.querySelector('[data-apos-form-recaptcha-error]');
        let token = tokenInput ? tokenInput.value : null;

        // If no token, try to generate a new one
        if (!token && window.grecaptcha) {
          try {
            token = await window.grecaptcha.execute(siteKey, { action: 'submit' });
            if (tokenInput) {
              tokenInput.value = token;
            }
          } catch (error) {
            // Silent error handling
          }
        }

        // Block submission if no token available
        if (!token) {
          e.preventDefault();
          e.stopPropagation();
          if (recaptchaError) {
            recaptchaError.classList.remove('apos-form-hidden');
            recaptchaError.style.display = 'block';
          }
          return false;
        }
      }, true);
    });
  })();
</script>
{% endif %}

<div class="{{ prependIfPrefix('') }}" data-apos-form-wrapper>
{% if form %}
  {% set params = false %}
  {% if form.queryParamList %}
    {% set params = '' %}
    {% for param in form.queryParamList %}
      {% if loop.last %}
        {% set params = params + param.key %}
      {% else %}
        {% set params = params + param.key + ',' %}
      {% endif %}
    {% endfor %}
  {% endif %}
  <form
    data-apos-form-form="{{ form._id }}"
    class="{{ prependIfPrefix('__form') }}" autocomplete="off"
    {% if form.enableQueryParams %}data-apos-form-params='{{params}}'{% endif %}
    {% if form.linkUrl %}data-apos-form-third-party-url="{{ form.linkUrl }}"{% endif %}
    {% if enableRecaptcha %}
      data-apos-recaptcha-sitekey="{{ captchaSite }}"
    {% endif %}
  >
    {% area form, 'contents' %}

    {% if enableRecaptcha %}
      <input type="hidden" name="recaptchaToken" id="recaptchaToken-{{ form._id }}" />
    {% endif %}
    <button
      type="submit" class="{{ prependIfPrefix('__submit') }}"
      data-apos-form-submit
    >
      {{ form.submitLabel or __t('aposForm:widgetSubmit') }}
    </button>
  </form>
  <p role="alert" data-apos-form-submit-error
    class="apos-form-hidden apos-form-error {{ prependIfPrefix('__error') }}"
  >
    {{ __t('aposForm:widgetSubmitError') }}
    <span data-apos-form-global-error></span>
  </p>

  {% if enableRecaptcha %}
    <p role="alert" data-apos-form-recaptcha-error
      class="apos-form-hidden apos-form-error {{ prependIfPrefix('__error') }}"
    >
      {{ __t('aposForm:widgetCaptchaError') }}
    </p>
  {% endif %}
  <p
    class="apos-form-hidden {{ prependIfPrefix('__spinner') }}"
    data-apos-form-spinner
  >
    {{ __t('aposForm:widgetSubmitting') }}
  </p>
  <div role="alert" data-apos-form-thank-you
    class="apos-form-hidden apos-form-submission-thank-you {{ prependIfPrefix('__submission-thank-you') }}"
  >
    <p class="font-semibold text-xl lg:text-2xl mb-2">{{ form.thankYouHeading or __t('aposForm:defaultThankYou') }}</p>
    {% if not apos.area.isEmpty(form, 'thankYouBody') %}
      {% area form, 'thankYouBody' %}
    {% endif %}
  </div>
{% endif %}
</div>